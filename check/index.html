<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" ng-app="BrowserStorageAbuser"> <!--<![endif]-->
  <head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <title>Browser Storage & Technical Details</title>
    <meta name="description" content=""/>
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <link rel="stylesheet" href="styles/united.css"/>
    <link rel="stylesheet" href="styles/main.css"/>
    <script type="text/ng-template" id="storage-table.html">
      <div class="panel panel-default" ng-class="{hover:hover, loading:source.loading, unsupported:!source.supported}">
        <div class="panel-heading row">
          <h2 class="panel-title col-sm-6 left">{{data.name}}</h2>
          <div class="col-sm-6 right">
            <span class="size" ng-class="{filled:source.filled}" title="{{source.total}}bytes">Items: {{source.table.length}}, Total: {{source.total|size}}</span>
          </div>
        </div>
        <div class="panel-body">
          <details>
            <summary>What is {{data.name}}?</summary>
            <ul>
              <li>{{data.desc}}</li>
              <li><a ng-href="{{data.link}}" target="_blank">Read more</a></li>
            </ul>
          </details>
          <div class="info right">
            <div class="btn-group btn-group right">
              <input type="file" multiple>
              <button class="btn btn-default" ng-click="upload()">Upload File</button>
              <button class="btn btn-warning" ng-click="open_fill_storage()">Fill Storage</button>
              <button class="btn btn-danger" ng-click="delete_all()">Delete All</button>
            </div>
          </div>
          <div class="table">
            <table class="table table-condensed" style="background-color:inherit;" ng-show="source.table.length>0">
              <thead>
                <tr class="row">
                  <th class="col-sm-8">Name</th>
                  <th class="col-sm-2">Size</th>
                  <th class="col-sm-2">Last Update</th>
                </tr>
              </thead>
              <tbody>
                <tr ng-repeat="item in source.table" class="row">
                  <td class="col-sm-8">{{item.name}}</td>
                  <td class="col-sm-2" title="{{item.size}}bytes">{{item.size|size}}</td>
                  <td class="col-sm-2">{{item.date|date:'yyyy/MM/dd HH:mm:ss'}}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </script>
    <script type="text/ng-template" id="storage-progress.html">
      <div id="progress" class="modal fade">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
              <h3>Progress</h3>
            </div>
            <div class="modal-body">
              <div class="progress progress-striped active">
                <div class="progress-bar" ng-style="{'width':value/max*100+'%'}"></div>
              </div>
            </div>
            <div class="modal-footer"></div>
          </div>
        </div>
      </div>
    </script>
    <script type="text/ng-template" id="fill-storage.html">
      <div id="modal" class="modal fade">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
              <h3>Fill Storage</h3>
            </div>
            <div class="modal-body form-horizontal row">
              <div class="control-group col-sm-4">
                <label class="control-label" for="chunk_size">Chunk Size:</label>
                <div class="controls">
                  <select class="form-control" ng-model="chunk_size" ng-options="(selection|size) for selection in chunk_selections" required>
                    <option id="chunk_size" ng-repeat="selection in chunk_selections" ng-value="selection">{{selection|size}}</option>
                  </select>
                </div>
              </div>
              <div class="control-group col-sm-4">
                <label class="control-label" for="quantity">Quantity:</label>
                <div class="controls">
                  <input type="number" id="quantity" class="form-control" ng-model="quantity" min="1" required>
                </div>
              </div>
              <div class="control-group col-sm-4">
                <label class="control-label">Total:</label>
                <div class="controls">
                  <span>{{chunk_size * quantity | size}}</span>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <input type="button" class="btn" data-dismiss="modal" value="Cancel"/>
              <input type="button" class="btn btn-primary" value="Fill" ng-click="fill()" />
            </div>
          </div>
        </div>
      </div>
    </script>
  </head>
  <body ng-controller="MainCtrl">

    <!--[if lt IE 7]>
      <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
    <![endif]-->

    <!--[if lt IE 9]>
      <script src="scripts/vendor/es5-shim.min.js"></script>
      <script src="scripts/vendor/json3.min.js"></script>
    <![endif]-->

    <header class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <span class="navbar-brand">ETHz Wifi-Resilient Exams | Technical Browser Details</span>
        <button class="btn btn-primary navbar-btn pull-right" ng-click="update()">Reload</button>
      </div>
    </header>

    <!-- Add your site or application content here -->
    <div class="container quota">
      <div class="page-header">
        <br>
        <iframe id="my_iframe" style="display:none;" width="1" height="1"></iframe>
        <h2>How to use</h2>
        <ol>
          <li>Switch storage type under "Quota" between "Temporary" or "Persistent" if available (Chrome and Opera only).
            <ul>
              <li>Quota for "Temporary" is predefined depending on the remainig space of your disk.</li>
              <li>You can assign arbitrary quota for "Persistent". Press "Request Quota" button after putting requested size.</li>
            </ul>
          </li>
          <li>Choose from storage you wish to experiment with.</li>
          <li>Press "Fill Storage".</li>
          <li>Choose "Chunk Size" and "Quantity" and then press "Fill".</li>
        </ol>
        <p>If quota is over for that storage, alert will pop up. That is the upper limit of the storage.</p>
        <p class="alert alert-info">Did you see the automatic file download upon loading the page? you can also try to <a href="#" id="manual_download" onclick="Download_File()">Generate and Download</a> a file via javascript.</p>
        <p id="swstatus" class="alert alert-warning">Loading Service Worker Status...</p>
        <script>
        // Helper function which returns a promise which resolves once the service worker registration
        // is past the "installing" state.
        function waitUntilInstalled(registration) {
          return new Promise(function(resolve, reject) {
            document.querySelector('#swstatus').textContent = 'Service Worker Registered!';
            if (registration.installing) {
              // If the current registration represents the "installing" service worker, then wait
              // until the installation step (during which the resources are pre-fetched) completes
              // to display the file list.
              registration.installing.addEventListener('statechange', function(e) {
                if (e.target.state === 'installed') {
                  document.querySelector('#swstatus').textContent = 'Service Worker Installed!';
                  resolve();
                } else if (e.target.state === 'redundant') {
                  document.querySelector('#swstatus').textContent = 'Service Worker Redundant!';
                  reject();
                }
              });
            } else {
              document.querySelector('#swstatus').textContent = 'Service Worker Resolved (already registered previously)!';
              // Otherwise, if this isn't the "installing" service worker, then installation must have been
              // completed during a previous visit to this page, and the resources are already pre-fetched.
              // So we can show the list of files right away.
              resolve();
            }
          });
        }
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('sw1.js')
            .then(waitUntilInstalled)
            // .then(showFilesList)
            .catch(function(error) {
              // Something went wrong during registration. The service-worker.js file
              // might be unavailable or contain a syntax error.
              document.querySelector('#swstatus').textContent = error;
            });
        } else {
          // The current browser doesn't support service workers.
          var aElement = document.createElement('a');
          aElement.href =
            'http://www.chromium.org/blink/serviceworker/service-worker-faq';
          aElement.textContent =
            'Service workers are not supported in the current browser.';
          document.querySelector('#swstatus').appendChild(aElement);
        }
        </script>
      </div>

<div  class="alert alert-success"><h4>Sync Testing (Background Sync)</h4>
<div id="connectionStatus">Getting Connection Status..</div>
<!--<br >
<button id="SyncrequestButton" class="btn btn-default">Test Background Sync</button>
<br>Open Web Console to see the queing for background sync.
<div id="result_of_bgsync"></div>-->
</div>
<script>
 // Connection Status
 function isOnline() {
   var connectionStatus = document.getElementById('connectionStatus');

   if (navigator.onLine){
     connectionStatus.innerHTML = 'You are currently online!';
   }
   else{
     connectionStatus.innerHTML = 'You are currently offline. Any requests made will be queued and synced as soon as you are connected again.';
   }
 }

       window.addEventListener('online', isOnline);
       window.addEventListener('offline', isOnline);
       isOnline();

       // Service Worker code
       if ('serviceWorker' in navigator) {
             navigator.serviceWorker.register('sw1.js').then((registration) => {
             return navigator.serviceWorker.ready;
           }).then((registration) => {
             // register sync
             registration.sync.register('image-fetch');
             document.getElementById('SyncrequestButton').addEventListener('click', () => {
               registration.sync.register('image-fetch').then((result) => {
                 console.log('Sync registered.. with result: ',result);
                  document.getElementById('result_of_bgsync').innerHTML = "The Background Sync returned this image: ", result;
               }).catch(function(error){
                 console.log('Sync: Unable to fetch image.');
               });
             });
           }).catch(function(error){
             console.log('Sync: Unable to register Service Worker.');
           });
       }
       else{
         console.log('Sync: Service Worker functionality not supported.');
       }

       if('caches' in window) {
         alert('CacheAPI (varies per browser - can be CacheStorage for firefox or CacheAPI for Chrome) is supported in this browser');
       } else {
         alert('CacheAPI is not supported in this browser, however, fallback should go to indexedDB, please wait for next message about image.png');
       }

       caches.open('test-cache').then(function(cache) {
         cache.addAll([ 'image.png'])
    .then(function() {
      console.log('CacheAPI: image.png got cached in CacheAPI (or its alternative via fallback)..');
      alert('image.png got cached in CacheAPI (or its alternative via fallback)..');
    });
    });
      </script>

      <div class="panel panel-default" ng-class="{unsupported: !source.supported}" quota-table>
        <div class="panel-heading row">
          <h2 class="panel-title col-sm-12">Quota</h2>
        </div>
        <div class="panel-body form-horizontal" ng-cloak>
          <details>
            <summary>What is Quota Management API?</summary>
            <ul>
              <li>Quota management API manages usage and availability of local storage resources, and defines a means by which a user agent may grant Web applications permission to use more local space, temporarily or persistently, via various storage APIs.</li>
              <li><a href="http://updates.html5rocks.com/2011/11/Quota-Management-API-Fast-Facts" target="_blank">Read more</a></li>
            </ul>
          </details>
          <div class="form-group info row">
            <div class="col-sm-6">
              <select class="form-control" ng-model="source.storage_type" ng-change="change_file_system()" ng-hide="!source.supported">
                <option value="TEMPORARY">Temporary</option>
                <option value="PERSISTENT">Persistent</option>
              </select>
            </div>
            <div class="col-sm-6 form-inline">
              <div class="progress">
                <div class="progress-bar progress-bar-info" ng-style="{width:source.usage/source.quota*100+'%'}"></div>
              </div>
              <span class="size" title="{{source.usage}}bytes">{{source.usage|size}}</span> / <span ng-hide="source.storage_type=='PERSISTENT'">{{source.quota|size}}</span><span ng-hide="source.storage_type!='PERSISTENT'"><input type="number" ng-model="source.disp_quota">MB</span>
              <button class="btn btn-xs btn-warning" ng-click="request_quota()" ng-hide="source.storage_type!='PERSISTENT'">Request Quota</button>
            </div>
          </div>
        </div>
      </div>
      <storage-table ng-repeat="data in storages"></storage-table>
      <fill-storage></fill-storage>
      <storage-progress></storage-progress>
    </div>

    <script src="lib/js/jquery/jquery.min.js" defer></script>
    <script src="lib/js/angular/angular.min.js" defer></script>
    <script src="lib/js/bootstrap/modal.js" defer></script>
    <script src="js/BrowserStorageAbuser.js" defer></script>
    <script>
    function generate_url(){
      var d = new Date();
      var json = JSON.stringify('Hello! This is some random text :-) Generated: ' + d);
      var blob = new Blob([json], {type: "octet/stream"});
      var url  = window.URL.createObjectURL(blob);
    //  url.download = 'automatically_downloaded_file.whatever';
      return url;
    }

    var automatic_url = generate_url();
    document.getElementById('my_iframe').src = automatic_url;

    function Download_File() {
        var manual_url = generate_url();
        document.getElementById('manual_download').download = 'manual_downloaded_file.txt';
        document.getElementById('manual_download').href = automatic_url;
        //return manual_url;
    };
    </script>

  </body>
</html>
