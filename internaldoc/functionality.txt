Functionality of the Fault-tolerant mode quiz plugin
====================================================

This plugin is designed to allow a student to continue working
on a deferred-feedback quiz attempt even if the network connection goes down.


Installation
------------

This plugin should be installed like any other Quiz access rule plugin. (Either
from the plugins DB; or download the zip, uncompress as wifiresilience and copy into
mod/quiz/accessrule;


Quiz setting
------------

Once installed, this plugin adds new setting on the Quiz settings form:
Extra restrictions on attempts -> Wifi-Resilient mode: Yes / No.
By default this is an advanced setting, hidden behind Show more ..., and it is off.

Note that the new setting is only available for quizzes with
How questions behave set to Deferred feedback, or similar.

This new setting is backed up and restored as appropriate when a Quiz or Course is.


Admin settings
--------------

This plugin adds a few new site-wide settings at
Site administration -> Plugins -> Activity modules -> Quiz -> Quiz fault-tolerant mode

You can set the default for whether the Experimental fault-tolerant mode is on
by default for new quizzes, and whether it is an advanced setting.

You can also set a public/private key pair, to be used when encrypting downloaded
responses (see below). public/private key pair is automatically generated on
install. You may delete the keys, in which case the downloads are not encrypted.


Capabilities
------------

This feature mostly uses the standard quiz capabilities. However it adds one
new one: quizaccess/wifiresilience:uploadresponses. Users with this capability
get an additional link on the quiz info info page, which takes them to a script
where they can upload response files saved on the client-side.


Logging
-------

All actions using the new plugin are logged like the equivalent actions for a
standard quiz attempt.


When the fault-tolerant mode is enabled
---------------------------------------

All the above is basically book-keeping. The interesting thing is what happens
when the quiz is attempted using this mode.

All the questions are downloaded at the start of the attempt, and it is then
possible to move from page to page of the attempt without any extra data being
downloaded from the server.

This includes being able to move to the Summary page and back.

The navigation block is updated to highlight the questions on the current page.

This also works correctly if the quiz is set to Navigation method: Sequential,
as well as the default Navigation method: Free.

If you flag a question, that is updated on the summary page as well as on the
page with the question an in the navigation.

When the response to a question is changed, the question status (beside the question,
in the navigation block, and on the summary page) is changed to 'Answer changed'.

Then, after the usual auto-save delay, the system tries to send the changes reponses
to the server.

(If auto-save is disabled for normal quizzes, then a delay of 1 minute is used.)

If that suceeds, the question state is updated (normally to Answer saved, or
Not yet answered) beside the question, in the navigation block, and on the summary
page. The Last saved time (in the navigation block) is then updated.

If the auto-save fails, then a warning is shown in the navigation block, with
a link to download your responses in encrypted form.

If you try to leave the quiz at a time when there are responses that have not
been successfully saved to the server, then you get a pop-up alert warning you,
which lets you either stay on the current page, or leave.

If, at any point you get logged out (this could be a system error, but to simulate
it you can open another tab and click the logout link) then a JavaScript dialogue
pops up to let you log in again and continue.

On the summary page, when you click Submit all and finish, you get the usual
Are you sure dialogue. Then, the submit button is replaced by a progress indicator.

If the submit succeeds, then you are redirected to the Review page (as usual,
according to the quiz settings. if review is not allowed you get sent to the view.php page.)

If the submit fails, then the Submit all and finish button re-appears, so you can
try again. That is accompanied by an explanatory message that includes the download
link again.

When you click the download link (in either location) the browser will download
a file. The file includes the quiz name, and the current time-stamp (plus some
other ids.) The file extension is .attemptdata. If you look in the file, you
will see that is is basically a text file containing JSON, with all the data
encrypted.


Uploading locally saved responses
---------------------------------

To use the downloaded file, as Admin, Manager or Editing teacher (strictly any
user with the quizaccess/wifiresilience:uploadresponses capability) go to the quiz
and click the 'upload exported responses' link.

That takes you to a page with a filepicker where you can upload one or more
downloaded files.

The form has an option for whether the each attempt should have
'Submit all and finish' done after the responses has been processed.

When the form is submitted, the files are processed. They processing is done
so that an error with one file/attempt will not prevent other files from being
processed.

For each file, there is a text box showing the decrypted data from the file.
(This is mainly to help debugging.) Then an indication of whether processing
the data succeeded. If the processing was successful, there is a link to
review the attempt.


Bonus debug tool
----------------

This is not a feature intended for users, but is useful for debugging. There
is a script .../mod/quiz/accessrule/wifiresilience/cryptotest.php which tests that
the cryptography libraries used can successfully encrypt some data (in JavaScript)
and then decrypt it again (in PHP on the server). It is worth knowing about this
for debugging.
