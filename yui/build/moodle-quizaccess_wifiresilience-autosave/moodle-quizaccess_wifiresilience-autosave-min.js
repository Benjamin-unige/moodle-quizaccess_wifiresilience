YUI.add("moodle-quizaccess_wifiresilience-autosave",(function(Y,NAME){M.quizaccess_wifiresilience=M.quizaccess_wifiresilience||{},M.quizaccess_wifiresilience.autosave={TINYMCE_DETECTION_DELAY:1e3,TINYMCE_DETECTION_REPEATS:10,WATCH_HIDDEN_DELAY:1e3,SAVE_TIMEOUT:3e4,SAVE_TIMEOUT_FULL_SUBMISSION:12e4,SELECTORS:{QUIZ_FORM:"#responseform",VALUE_CHANGE_ELEMENTS:'input, textarea, [contenteditable="true"]',CHANGE_ELEMENTS:"input, select",CONNECTION_ELEMENTS:"#quizaccess_wifiresilience_hidden_cxn_status",CHANGE_DRAGS:"li.matchdrag",HIDDEN_INPUTS:"input[type=hidden]",NAV_BUTTON:"#quiznavbutton",QUESTION_CONTAINER:"#q",STATE_HOLDER:" .state",SUMMARY_ROW:".quizsummaryofattempt tr.quizsummary",STATE_COLUMN:" .c1",ATTEMPT_ID_INPUT:"input[name=attempt]",FINISH_ATTEMPT_INPUT:"input[name=finishattempt]",SUBMIT_BUTTON:"#wifi_exam_submission_finish",FORM:"form",SAVING_NOTICE:"#quiz-saving",LAST_SAVED_MESSAGE:"#quiz-last-saved-message",LAST_SAVED_TIME:"#quiz-last-saved",SAVE_FAILED_NOTICE:"#mod_quiz_navblock .quiz-save-failed",LIVE_STATUS_AREA:"#quiz-server-status"},AUTOSAVE_HANDLER:M.cfg.wwwroot+"/mod/quiz/accessrule/wifiresilience/sync.php",LOCAL_STORAGE_KEY_PREFIX:"Wifiresilience-exams-responses-",RELOGIN_SCRIPT:M.cfg.wwwroot+"/mod/quiz/accessrule/wifiresilience/relogin.php",delay:2e4,total_offline_time:0,real_offline_time:0,last_disconnection_time:0,last_real_disconnection_time:0,keyname:null,courseid:null,cmid:null,cid:null,userid:null,attemptid:null,display_tech_errors:0,display_nav_details:0,disconnection_events:[],final_submission_time:0,form:null,connected:null,livewatch:null,serviceworker_supported:null,offline_happened_on:0,real_offline_happened_on:0,dirty:!1,delay_timer:null,usageid:null,save_transaction:null,save_start_time:null,last_successful_save:null,last_successful_server_save_timestamp:0,editor_change_handler:null,hidden_field_values:{},local_storage_key:null,sync_string_errors:"",locally_stored_data:{last_change:0,last_save:0,final_submission_time:0,userid:null,real_offline_time:0,total_offline_time:0,cid:null,cmid:null,attemptid:null,responses:""},init:function(delay,keyname,courseid,cmid,display_tech_errors,display_nav_details,usageid){if(this.form=Y.one(this.SELECTORS.QUIZ_FORM),this.form){quizaccess_wifiresilience_progress_step=5,$("#quizaccess_wifiresilience_result").html(M.util.get_string("loadingstep5","quizaccess_wifiresilience")),this.connected=!0,this.livewatch=!0,this.total_offline_time=0,this.real_offline_time=0,this.display_tech_errors=display_tech_errors,this.display_nav_details=display_nav_details,this.sync_string_errors="",this.attemptid=Y.one(this.SELECTORS.ATTEMPT_ID_INPUT).get("value"),this.usageid=usageid,"undefined"!=typeof Storage&&sessionStorage.getItem("real-offline-time-"+this.attemptid)&&(this.real_offline_time=Number(sessionStorage.getItem("real-offline-time-"+this.attemptid))),this.last_disconnection_time=0,this.last_real_disconnection_time=0,M.quizaccess_wifiresilience.autosave.offline_happened_on=0,M.quizaccess_wifiresilience.autosave.real_offline_happened_on=0,M.core_question_engine.init_form(Y,this.SELECTORS.QUIZ_FORM),Y.on("submit",M.mod_quiz.timer.stop,this.SELECTORS.QUIZ_FORM),window.onbeforeunload=Y.bind(this.warn_if_unsaved_data,this),this.delay=1e3*delay,this.local_storage_key=keyname,this.courseid=courseid,this.cmid=cmid,this.userid=Y.one("#quiz-userid").get("value"),storeddata=M.quizaccess_wifiresilience.localforage.get_status_records(),this.form.delegate("valuechange",this.value_changed,this.SELECTORS.VALUE_CHANGE_ELEMENTS,this),this.form.delegate("change",this.value_changed,this.SELECTORS.CHANGE_ELEMENTS,this);var submitAndFinishButton=Y.one(this.SELECTORS.SUBMIT_BUTTON);submitAndFinishButton.detach("click"),submitAndFinishButton.on("click",this.submit_and_finish_clicked,this),Y.DD.DDM.on("drag:drophit",this.value_changed_drag,this),Y.DD.DDM.on("drag:dropmiss",this.value_changed_drag,this),this.create_status_messages(),this.init_tinymce(this.TINYMCE_DETECTION_REPEATS),this.save_hidden_field_values(),this.watch_hidden_fields(),$("textarea").attr("autocomplete",!1),$("textarea").attr("autocorrect",!1),$("textarea").attr("autocapitalize",!1),$("textarea").attr("spellcheck",!1),"serviceWorker"in navigator?this.serviceworker_supported=1:this.serviceworker_supported=0,M.quizaccess_wifiresilience.localforage.try_to_get_question_states();var examviewportmaxwidth=$(window).width(),quizaccess_wifiresilience_progress;$(".quizaccess_wifiresilience_progress .quizaccess_wifiresilience_bar").animate({width:5*examviewportmaxwidth/10+"px"})}else Y.log("No response form found. Why did you try to set up autosave?","debug","[Wifiresilience-SW] Sync")},try_to_use_locally_saved_responses:function(){for(var prefill,alreadyusedparams=[],hashParams=this.locally_stored_data.responses.split("&"),reloaded_form_str="Loading (From localStorage)\n",i=0;i<hashParams.length;i++){var p=hashParams[i].split("="),name=decodeURIComponent(p[0]),val=decodeURIComponent(p[1]);if("sesskey"!=name){var $el;if(0==($el=$('[name="'+name+'"]')).length&&($el=$('[id="'+name+'"]')),$el.length>1&&alreadyusedparams.indexOf(name)>-1){var $eltemp=$('[name="'+name+'"]')[1];0==$eltemp.length&&($eltemp=$('[id="'+name+'"]')[1]);var type=($el=$($eltemp)).attr("type");console.log("DUPLICATE FIELD: More than one element hold same name/id. Now we are selecting: ",$el)}else var type=$el.attr("type");if(alreadyusedparams.push(name),-1!==name.indexOf("_sub")&&$('ul[name^="'+name+'"]').length&&$('ul[name^="'+name+'"]').attr("id")&&$('ul[name^="'+name+'"]').attr("id").length){var elementid=$('ul[name^="'+name+'"]').attr("id"),fullsepid,fullsepids=elementid.replace("ultarget","").split("_"),qid=fullsepids[0],stemid=fullsepids[1],target_value=$("#ulorigin"+qid).find("[data-id='"+val+"']");if(target_value&&target_value.length){var target_value_html=target_value.html();target_value_html&&"undefined"!=target_value_html&&($("#"+elementid).find(".placeholder").addClass("hidden"),$("#"+elementid).append('<li data-id="'+val+'" class="matchdrag yui3-dd-draggable prepicked-by-ethz-quiz yui3-dd-dragging copy" style="cursor: move;">'+target_value_html+"</li>"))}}switch(type){case"checkbox":var $el;if(0==($el=$("input[type='checkbox'][name='"+name+"']")).length)var $el=$("input[type='checkbox'][id='"+name+"']");0==val?$el.prop("checked",!1).change():$el.attr("checked","checked").change();var checkboxid=$el.attr("id");checkboxid&&"undefined"!=checkboxid&&-1!==checkboxid.indexOf("_distractor")&&($el.trigger("click"),$el.trigger("change"),$el.trigger("click"),$el.val(1));break;case"radio":$el.filter('[value="'+val+'"]').attr("checked","checked").change(),$el.filter('[value="'+val+'"]').trigger("click"),$el.trigger("change");break;default:if($el.is("textarea")){$el.text(val).change();var currentattrid=$el.attr("id");if(-1!==currentattrid.indexOf("qtype_drawing_textarea_id_")){var qidarr=currentattrid.split("_"),iframedr="#qtype_drawing_editor_"+qidarr[4]+"_"+qidarr[5]+"_"+qidarr[6]+"_uniqueuattemptid";$(iframedr).attr("src",$(iframedr).attr("src"))}else $el.val(val).change()}else{var $el;if($el.is("select")&&$("[name='"+name+"'] option[value='"+val+"']").attr("selected","selected"),"undefined"!=type)if(0==($el=$("input[type='"+type+"'][name='"+name+"']")).length)var $el=$("input[type='"+type+"'][id='"+name+"']");$el.val(val).change()}}}}Y.log("[LOCALSTORAGE]: Exam Reloaded before Saving. "+reloaded_form_str,"debug","[Wifiresilience-SW] Sync")},save_hidden_field_values:function(){this.form.all(this.SELECTORS.HIDDEN_INPUTS).each((function(hidden){var name=hidden.get("name");name&&(this.hidden_field_values[name]=hidden.get("value"))}),this)},watch_hidden_fields:function(){this.detect_hidden_field_changes(),Y.later(this.WATCH_HIDDEN_DELAY,this,this.watch_hidden_fields)},detect_hidden_field_changes:function(){this.form.all(this.SELECTORS.HIDDEN_INPUTS).each((function(hidden){var name=hidden.get("name"),value=hidden.get("value");name&&"sesskey"!==name&&(name in this.hidden_field_values&&value===this.hidden_field_values[name]||(this.hidden_field_values[name]=value,this.value_changed({target:hidden})))}),this)},init_tinymce:function(repeatcount){"undefined"!=typeof tinyMCE?(Y.log("Found TinyMCE.","debug","[Wifiresilience-SW] Sync"),this.editor_change_handler=Y.bind(this.editor_changed,this),tinyMCE.onAddEditor.add(Y.bind(this.init_tinymce_editor,this))):repeatcount>0?Y.later(this.TINYMCE_DETECTION_DELAY,this,this.init_tinymce,[repeatcount-1]):Y.log("Gave up looking for old dirty TinyMCE.","debug","[Wifiresilience-SW] Sync")},init_tinymce_editor:function(e,editor){Y.log("Found TinyMCE editor "+editor.id+".","debug","[Wifiresilience-SW] Sync"),editor.onChange.add(this.editor_change_handler),editor.onRedo.add(this.editor_change_handler),editor.onUndo.add(this.editor_change_handler),editor.onKeyDown.add(this.editor_change_handler)},value_changed_drag:function(e){if(void 0!==e.drop){var name=e.drop.get("node").getData("selectname");Y.log("Detected a value change in DRAG question.","debug","[Wifiresilience-SW] Sync"),this.start_save_timer_if_necessary(),this.mark_question_changed_if_necessary(name)}},connection_changed:function(e){Y.log("Detected change in Connection Status to "+this.connected,"debug","[Wifiresilience-SW] Timer");var total_seconds_missing=0;0!=this.offline_happened_on&&(total_seconds_missing=Math.floor(((new Date).getTime()-this.offline_happened_on)/1e3),this.total_offline_time+=total_seconds_missing,this.disconnection_events.push(total_seconds_missing),this.last_disconnection_time=total_seconds_missing,this.offline_happened_on=0,this.last_disconnection_time=0),this.connected?(this.offline_happened_on=0,this.last_disconnection_time=0,0!=total_seconds_missing&&Y.log("Total disconnection seconds (will not be compensated because the user is able to continue the exam): ["+total_seconds_missing+"] Seconds","debug","[Wifiresilience-SW] Timer")):this.offline_happened_on=(new Date).getTime()},real_connection_icon_status:function(status){Y.log("Is Exam Server up and running?! "+status,"debug","[Wifiresilience-SW] Server Status");var el=document.querySelector("#quizaccess_wifiresilience_connection"),cxn_hidden;0==document.querySelector("#quizaccess_wifiresilience_hidden_cxn_status").value&&(status=!1,Y.log("Device is not connected to internet - Ignore Server Status and mark it as offline: "+status,"debug","[Wifiresilience-SW] Server Status")),status?el.classList?(el.classList.add("connected"),el.classList.remove("disconnected")):(el.addClass("connected"),el.removeClass("disconnected")):el.classList?(el.classList.remove("connected"),el.classList.add("disconnected")):(el.removeClass("connected"),el.addClass("disconnected"))},livewatch_connection_changed:function(e){if(Y.log("Detected Livewatch: "+this.livewatch,"debug","[Wifiresilience-SW] Timer"),this.livewatch){var total_real_seconds_missing=0;0!=this.real_offline_happened_on&&(total_real_seconds_missing=Math.floor(((new Date).getTime()-this.real_offline_happened_on)/1e3),this.real_offline_time+=total_real_seconds_missing,this.last_real_disconnection_time=total_real_seconds_missing),this.real_offline_happened_on=0,M.mod_quiz.timer.update(e),this.last_real_disconnection_time=0,this.real_connection_icon_status(!0),Y.log("Total REAL missing seconds which got compensated:["+total_real_seconds_missing+"] Seconds","debug","[Wifiresilience-SW] Timer")}else M.mod_quiz.timer.stop(e),this.real_offline_happened_on=(new Date).getTime(),this.real_connection_icon_status(!1)},value_changed:function(e){var name=e.target.getAttribute("name");"thispage"===name||"scrollpos"===name||name&&name.match(/_:flagged$/)||("quizaccess_wifiresilience_cxn_status"!==name?"quizaccess_wifiresilience_livewatch_status"!==name?(name=name||"#"+e.target.getAttribute("id"),Y.log("Detected a value change in element "+name+".","debug","[Wifiresilience-SW] Sync"),this.start_save_timer_if_necessary(),this.mark_question_changed_if_necessary(name)):this.livewatch_connection_changed(e):this.connection_changed(e))},editor_changed:function(editor){Y.log("Detected a value change in editor "+editor.id+".","debug","[Wifiresilience-SW] Sync"),this.start_save_timer_if_necessary(),this.mark_question_changed_if_necessary(editor.id)},mark_question_changed_if_necessary:function(elementname){var slot=this.get_slot_from_id(elementname);slot&&(this.set_question_state_string(slot,M.util.get_string("answerchanged","quizaccess_wifiresilience")),this.set_question_state_class(slot,"answersaved"),M.quizaccess_wifiresilience.localforage.update_question_state_class(slot,"answersaved"),M.quizaccess_wifiresilience.localforage.update_question_state_string(slot,M.util.get_string("answerchanged","quizaccess_wifiresilience")))},get_slot_from_id:function(elementname){var matches=elementname.match(/^#?q\d+:(\d+)_.*$/),momo;return matches?matches[1]:$('input[name="'+elementname+'"]').closest("[id*=quizaccess_wifiresilience-attempt_page-]").attr("data-qslot")},set_question_state_string:function(slot,newstate){Y.log("State of question "+slot+" changed to "+newstate+".","debug","[Wifiresilience-SW] Sync"),Y.one(this.SELECTORS.QUESTION_CONTAINER+slot)?Y.one(this.SELECTORS.QUESTION_CONTAINER+slot+this.SELECTORS.STATE_HOLDER).setHTML(Y.Escape.html(newstate)):Y.one('div[id="question-'+this.usageid+"-"+slot+'"]'+this.SELECTORS.STATE_HOLDER).setHTML(Y.Escape.html(newstate));var summaryRow=Y.one(this.SELECTORS.SUMMARY_ROW+slot+this.SELECTORS.STATE_COLUMN);summaryRow&&summaryRow.setHTML(Y.Escape.html(newstate)),Y.one(this.SELECTORS.NAV_BUTTON+slot).set("title",Y.Escape.html(newstate))},update_question_state_strings:function(statestrings){Y.Object.each(statestrings,(function(state,slot){this.set_question_state_string(slot,state)}),this)},set_question_state_class:function(slot,newstate){Y.log("State of question "+slot+" changed to "+newstate+".","debug","[Wifiresilience-SW] Sync");var navButton=Y.one(this.SELECTORS.NAV_BUTTON+slot);navButton.set("className",navButton.get("className").replace(/^qnbutton \w+\b/,"qnbutton "+Y.Escape.html(newstate)))},update_question_state_classes:function(stateclasses){Y.Object.each(stateclasses,(function(state,slot){this.set_question_state_class(slot,state)}),this)},start_save_timer_if_necessary:function(){this.dirty=!0,this.locally_stored_data.last_change=new Date,this.locally_stored_data.responses=Y.IO.stringify(this.form);var stringified_data=Y.JSON.stringify(this.locally_stored_data);M.quizaccess_wifiresilience.localforage.save_status_records(stringified_data),this.exam_localstorage_saving_status_str(),this.delay_timer||this.save_transaction||(Y.log("Changes worth syncing? Yes.. Flag Syncing to run after: "+this.delay+" milliseconds.","debug","[Wifiresilience-SW] Sync"),this.start_save_timer())},start_save_timer:function(){this.cancel_delay(),this.delay_timer=Y.later(this.delay,this,this.save_changes)},cancel_delay:function(){this.delay_timer&&!0!==this.delay_timer&&this.delay_timer.cancel(),this.delay_timer=null},get_live_exam_time:function(){Y.log("Trying to get Exam End Time in case of changes","debug","[Wifiresilience-SW] Sync")},exam_time_done:function(transactionid,response){Y.log("Exam End Time checks on server: SUCCESS. Exam End Time: "+timeresult.duedate,"debug","[Wifiresilience-SW] Sync")},exam_time_failed:function(transactionid,response){Y.log("Exam End Time checks on server: FAILED. "+response.responseText,"debug","[Wifiresilience-SW] Sync")},save_changes:function(){this.cancel_delay(),this.dirty=!1,this.locally_stored_data.responses=Y.IO.stringify(this.form);var stringified_data=Y.JSON.stringify(this.locally_stored_data);if(M.quizaccess_wifiresilience.localforage.save_status_records(stringified_data),Y.log("Saving Exam Elements Status in indexedDB.","debug","[Wifiresilience-SW] Sync"),M.quizaccess_wifiresilience.localforage.save_attempt_records_encrypted(),Y.log("Saving Exam Encrypted Emergency File in indexedDB.","debug","[Wifiresilience-SW] Sync"),this.is_time_nearly_over())return Y.log("No more saving, time is nearly over.","debug","[Wifiresilience-SW] Sync"),void this.stop_autosaving();Y.log("Start Syncing with Exam Server.","debug","[Wifiresilience-SW] Sync"),"undefined"!=typeof tinyMCE&&tinyMCE.triggerSave(),this.save_transaction=Y.io(this.AUTOSAVE_HANDLER,{method:"POST",form:{id:this.form},on:{success:this.save_done,failure:this.save_failed},context:this,timeout:this.SAVE_TIMEOUT,sync:!1}),this.save_start_time=new Date,1==this.display_nav_details&&Y.one(this.SELECTORS.SAVING_NOTICE).setStyle("display","block")},save_done:function(transactionid,response){var result;try{result=Y.JSON.parse(response.responseText)}catch(e){return void this.save_failed(transactionid,response)}if("lostsession"===result.result)return Y.log("Session loss detected. Re-Login required","debug","[Wifiresilience-SW] Sync"),this.save_transaction=null,this.dirty=!0,void this.try_to_restore_session();if("OK"===result.result){this.sync_string_errors="",this.last_successful_server_save_timestamp=new Date,this.save_transaction=null;var original_end_time=Y.one("#original_end_time").get("value");if(!isNaN(result.timerstartvalue)&&M.mod_quiz.timer.endtime&&original_end_time!=result.timelimit){var addexloadingtime=0;exam_extra_page_load_time&&"undefined"!=exam_extra_page_load_time&&(addexloadingtime=exam_extra_page_load_time),Y.log("Page load comepnsation autosave (exam end): "+addexloadingtime,"debug","[Wifiresilience-SW] Sync");var t=(new Date).getTime();M.mod_quiz.timer.endtime=exam_extra_page_load_time+t+1e3*result.timerstartvalue,Y.log("Exam End Time checks on server: SUCCESS. Exam End Time: "+result.timerstartvalue,"debug","[Wifiresilience-SW] Sync")}else Y.log("Exam End Time checks on server: Original Exam End Time: "+original_end_time+" & Last Server Check End Time: "+result.timelimit+". No Need to Compensate or Update Quiz Timer.","debug","[Wifiresilience-SW] Sync");this.real_connection_icon_status(!0),this.update_status_for_successful_save(),this.update_question_state_classes(result.questionstates),this.update_question_state_strings(result.questionstatestrs),Y.log("[SUCCESSFUL] Full Sync to server completed.","debug","[Wifiresilience-SW] Sync"),this.real_connection_icon_status(!0),M.quizaccess_wifiresilience.localforage.save_question_state_classes(result.questionstates),M.quizaccess_wifiresilience.localforage.save_question_state_strings(result.questionstatestrs),this.dirty&&(Y.log("Dirty after syncing. Need to re-sync again.","debug","[Wifiresilience-SW] Sync"),this.start_save_timer())}else{if(result.error){var sync_errors=result.error+" (Code: "+result.errorcode+") Info: "+result.debuginfo;this.sync_string_errors=result.error,Y.log("Error: "+sync_errors,"debug","[Wifiresilience-SW] Sync")}this.save_failed(transactionid,response)}},save_failed:function(){this.real_connection_icon_status(!1),Y.log("Syncing with Exam Server: failed. Plan B: Local Storage.","debug","[Wifiresilience-SW] Sync"),this.save_transaction=null,this.update_status_for_failed_save(),this.save_start_time=null,this.dirty=!0,this.start_save_timer()},is_time_nearly_over:function(){calculated_delay=(new Date).getTime()+2*this.delay,time_nearly_over=M.mod_quiz.timer&&M.mod_quiz.timer.endtime&&calculated_delay>M.mod_quiz.timer.endtime},stop_autosaving:function(){this.cancel_delay(),this.delay_timer=!0,this.save_transaction&&this.save_transaction.abort()},warn_if_unsaved_data:function(e){var sessionstorage_attempt_key="wifiresilience-secondsleft-"+this.attemptid;if(navigator.onLine)sessionStorage.removeItem(sessionstorage_attempt_key);else{var secondsleft=Math.floor((M.mod_quiz.timer.endtime-(new Date).getTime())/1e3);sessionStorage.setItem(sessionstorage_attempt_key,secondsleft)}if(this.dirty||this.save_transaction){if(this.save_changes(),0==this.serviceworker_supported){var data={responses:Y.IO.stringify(M.quizaccess_wifiresilience.download.form)};M.quizaccess_wifiresilience.download.publicKey&&(data=M.quizaccess_wifiresilience.download.encryptResponses(data));var blob=new Blob([Y.JSON.stringify(data)],{type:"octet/stream"}),url=window.URL.createObjectURL(blob);$("#mod_quiz_navblock").append('<iframe id="wifi_unload_download_iframe" width="1" height="1" frameborder="0" src="'+url+'"></iframe>')}return"undefined"!=typeof Storage&&(sessionStorage.setItem("wifiresilience-offline-"+this.attemptid,this.real_offline_time),sessionStorage.setItem("wifiresilience-offline-lastpage-"+this.attemptid,M.quizaccess_wifiresilience.navigation.currentpage)),e.returnValue=M.util.get_string("changesmadereallygoaway","quizaccess_wifiresilience"),e.returnValue}},submit_and_finish_clicked:function(e){e.halt(!0);var confirmationDialogue=new M.core.confirm({id:"submit-confirmation",width:"300px",center:!0,modal:!0,visible:!1,draggable:!1,title:M.util.get_string("confirmation","admin"),noLabel:M.util.get_string("cancel","moodle"),yesLabel:M.util.get_string("submitallandfinish","quiz"),question:M.util.get_string("confirmclose","quiz")});confirmationDialogue.on("complete-yes",this.submit_and_finish,this),confirmationDialogue.render().show()},submit_and_finish:function(e){e.preventDefault(),e.stopPropagation(),0==this.final_submission_time&&(this.final_submission_time=Math.round((new Date).getTime()/1e3)-this.real_offline_time),this.stop_autosaving();var submitButton=Y.one(this.SELECTORS.SUBMIT_BUTTON);this.get_submit_progress(submitButton.ancestor(".controls")).show(),submitButton.ancestor(".singlebutton").hide();var failureMessage=this.get_submit_failed_message(submitButton.ancestor(".controls"));submitButton.ancestor(".controls").removeClass("quiz-save-failed"),failureMessage.header.hide(),failureMessage.message.hide(),this.form.append('<input name="finishattempt" value="1">'),this.form.append('<input type="hidden" name="final_submission_time" value="'+this.final_submission_time+'">'),Y.log("Trying to do final submission to the server.. Brace! Brace! Brace! :-)","debug","[Wifiresilience-SW] Sync"),"undefined"!=typeof tinyMCE&&tinyMCE.triggerSave(),this.save_transaction=Y.io(this.AUTOSAVE_HANDLER,{method:"POST",form:{id:this.form},on:{success:this.submit_done,failure:this.submit_failed},context:this,timeout:this.SAVE_TIMEOUT_FULL_SUBMISSION,sync:!1}),this.save_start_time=new Date},submit_done:function(transactionid,response){var result;try{result=Y.JSON.parse(response.responseText)}catch(e){return Y.log("Final Submission Failure Reason (Transaction: "+transactionid+"): "+response.responseText,"debug","[Wifiresilience-SW] Sync"),void this.submit_failed(transactionid,response)}"OK"===result.result?(this.real_connection_icon_status(!0),Y.log("Final Submit Successful, Retard! Retard! Retard! [Redirecting out of Exam..]","debug","[Wifiresilience-SW] Sync"),this.save_transaction=null,this.dirty=!1,Y.log("Deleting local records after successful exam..","debug","[Wifiresilience-SW] Sync"),M.quizaccess_wifiresilience.localforage.delete_records_after_successful_submission(),window.location.replace(result.reviewurl)):this.submit_failed(transactionid,response)},submit_failed:function(transactionid=null,response=null){this.real_connection_icon_status(!1),Y.log("Final Submit failed. Emergency! Emergency! Emergency! [Offering to Download Responses..]","debug","[Wifiresilience-SW] Sync"),this.save_transaction=null,this.form.one(this.SELECTORS.FINISH_ATTEMPT_INPUT).remove();var submitButton=Y.one(this.SELECTORS.SUBMIT_BUTTON),submitProgress=this.get_submit_progress(submitButton.ancestor(".controls"));submitButton.ancestor(".singlebutton").show(),submitProgress.hide();var failureMessage=this.get_submit_failed_message(submitButton.ancestor(".controls")),submitAndFinishButton;function response_is_json_string(str){try{JSON.parse(str)}catch(e){return!1}return!0}submitButton.ancestor(".controls").addClass("quiz-save-failed"),failureMessage.header.show(),failureMessage.message.show(),this.update_status_for_failed_save(),Y.one(this.SELECTORS.SUBMIT_BUTTON).set("value",M.util.get_string("submitallandfinishtryagain","quizaccess_wifiresilience")),response&&(response_is_json_string(response.responseText)?(error_results=Y.JSON.parse(response.responseText),nice_merror_message=error_results.error+" ("+error_results.errorcode+")",Y.log(nice_merror_message,"debug","[Wifiresilience-SW] Sync")):(nice_merror_message="Server Connection Error.",Y.log(response,"debug","[Wifiresilience-SW] Sync"))),$("#wifi_debug_exam_error_details")&&$("#wifi_debug_exam_error_details").html("");var d,whenhappened=(new Date).toUTCString();1==this.display_tech_errors&&$(".submit-failed-message").append("<div id=\"wifi_debug_exam_error_details\"><hr><font color='red'>"+whenhappened+": "+nice_merror_message+"</font></div>");var data={responses:Y.IO.stringify(M.quizaccess_wifiresilience.download.form)};M.quizaccess_wifiresilience.download.publicKey&&(data=M.quizaccess_wifiresilience.download.encryptResponses(data));var blob=new Blob([Y.JSON.stringify(data)],{type:"octet/stream"}),url=window.URL.createObjectURL(blob);$(".submit-failed-message").append('<iframe id="wifi_automatic_download_iframe" width="1" height="1" frameborder="0" src="'+url+'"></iframe>')},get_submit_progress:function(controlsDiv){var submitProgress=controlsDiv.one(".submit-progress");return submitProgress||(submitProgress=controlsDiv.appendChild('<div class="submit-progress">'),M.util.add_spinner(Y,submitProgress).show(),submitProgress.append(M.util.get_string("submitting","quizaccess_wifiresilience")),submitProgress)},get_submit_failed_message:function(controlsDiv){var failedHeader=controlsDiv.one(".submit-failed-header");if(failedHeader)return{header:failedHeader,message:controlsDiv.one(".submit-failed-message")};controlsDiv.insert('<div class="submit-failed-header">',0),(failedHeader=controlsDiv.one(".submit-failed-header")).append("<h4>"+M.util.get_string("submitfailed","quizaccess_wifiresilience")+"</h4>"),failedHeader.append("<p>"+M.util.get_string("submitfailedmessage","quizaccess_wifiresilience")+"</p>");var downloadLink='<a href="#" class="response-download-link btn button" style="margin-top:40px;">'+M.util.get_string("savetheresponses","quizaccess_wifiresilience")+"</a>",failedMessage=controlsDiv.appendChild('<div class="submit-failed-message">');return failedMessage.append("<p>"+M.util.get_string("submitfaileddownloadmessage","quizaccess_wifiresilience",downloadLink)+"</p>"),{header:failedHeader,message:failedMessage}},create_status_messages:function(){var last_saved_msg_str="",saving_dots_str="";1==this.display_nav_details&&(last_saved_msg_str=M.util.get_string("lastsaved","quizaccess_wifiresilience",'<span id="quiz-last-saved"></span>'),saving_dots_str=M.util.get_string("savingdots","quizaccess_wifiresilience")),Y.one("#mod_quiz_navblock .content").append('<div id="quiz-save-status"><div id="quiz-last-saved-message">'+last_saved_msg_str+'</div><div id="quiz-saving">'+saving_dots_str+'</div><div class="quiz-save-failed" style="display:none!important"></div></div>'),this.save_start_time=new Date,this.update_status_for_successful_save(),this.save_start_time=null},exam_saving_time_pad:function(number){return number<10?"0"+number:number},exam_localstorage_saving_status_str:function(){var latest_localstorage_timing=new Date(this.locally_stored_data.last_change);1==this.display_nav_details&&Y.one(this.SELECTORS.LAST_SAVED_TIME).setHTML(this.exam_saving_time_pad(this.last_successful_save.getHours())+":"+this.exam_saving_time_pad(this.last_successful_save.getMinutes())+":"+this.exam_saving_time_pad(this.last_successful_save.getSeconds())+M.util.get_string("localstorage","quizaccess_wifiresilience")+this.exam_saving_time_pad(latest_localstorage_timing.getHours())+":"+this.exam_saving_time_pad(latest_localstorage_timing.getMinutes())+":"+this.exam_saving_time_pad(latest_localstorage_timing.getSeconds()))},update_status_for_successful_save:function(){function pad(number){return number<10?"0"+number:number}wifi_current_time=Date(),this.last_successful_save=new Date(wifi_current_time),this.last_successful_server_save_timestamp=new Date(wifi_current_time),this.exam_localstorage_saving_status_str(),Y.one(this.SELECTORS.SAVING_NOTICE).setStyle("display","none"),Y.one(this.SELECTORS.SAVING_NOTICE).setHTML(M.util.get_string("savingdots","quizaccess_wifiresilience")),Y.one(this.SELECTORS.SAVE_FAILED_NOTICE).hide(),this.locally_stored_data.last_save=this.last_successful_server_save_timestamp;var stringified_data=Y.JSON.stringify(this.locally_stored_data);M.quizaccess_wifiresilience.localforage.save_status_records(stringified_data),this.save_start_time=null},update_status_for_failed_save:function(){1==this.display_nav_details&&(Y.one(this.SELECTORS.LAST_SAVED_MESSAGE).setHTML(M.util.get_string("lastsavedtotheserver","quizaccess_wifiresilience",Y.one(this.SELECTORS.LAST_SAVED_TIME).get("outerHTML"))),Y.one(this.SELECTORS.SAVING_NOTICE).setStyle("display","none"),Y.one(this.SELECTORS.SAVING_NOTICE).setHTML(M.util.get_string("savingtryagaindots","quizaccess_wifiresilience")+"<div></div>"),Y.one(this.SELECTORS.SAVE_FAILED_NOTICE).show())},try_to_restore_session:function(){this.loginDialogue=new M.core.notification.info({id:"quiz-relogin-dialogue",width:"70%",center:!0,modal:!0,visible:!1,draggable:!1}),this.loginDialogue.setStdModContent(Y.WidgetStdMod.HEADER,'<h1 id="moodle-quiz-relogin-dialogue-header-text">'+M.util.get_string("logindialogueheader","quizaccess_wifiresilience")+"</h1>",Y.WidgetStdMod.REPLACE),this.loginDialogue.setStdModContent(Y.WidgetStdMod.BODY,'<iframe src="'+this.RELOGIN_SCRIPT+"?userid="+Y.one("#quiz-userid").get("value")+'">',Y.WidgetStdMod.REPLACE),this.loginDialogue.render().show()},restore_session_complete:function(sesskey){Y.all("input[name=sesskey]").set("value",sesskey),this.loginDialogue&&(this.loginDialogue.hide().destroy(),this.loginDialogue=null),this.save_changes()}}}),"@VERSION@",{requires:["base","node","event","event-valuechange","node-event-delegate","io-form","json","core_question_engine","mod_quiz","dd-delegate","dd-drop-plugin","dd-proxy","dd-constrain","selector-css3"]});